---
title: "SWS_NWCA"
author: "Wills et al"
date: "January 4, 2018"
output: html_document
---

comparing datasets

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

rm(list=ls()) #clear previous data

require("knitr")
knitr::opts_chunk$set(echo = TRUE, comment = "#", warning = FALSE, message = FALSE, error =FALSE, tidy.opts=list(width.cutoff=60),tidy=TRUE)


list.of.packages <- c("ggplot2", "plyr", "Rcpp", "RColorBrewer", "lattice", "aqp", "stringr", "reshape2", "ggthemes", "tidyverse", "RCurl", "Hmisc", "gridExtra", 'ggmosaic', 'ggpmisc', 'png','rstan','lme4', 'printr', "dplyr","tidyr",  "hexbin", "ggbeeswarm", "viridis", "gridExtra", "cetcolor", "ggjoy", "readxl", "sp", "maps", "maptools", "rgdal", "soilDB", "GGally")

new.packages <- list.of.packages[!(list.of.packages %in% installed.packages()[,"Package"])]
if(length(new.packages)) install.packages(new.packages)

library(tidyverse)
library(Rcpp)
library(RColorBrewer)
library(lattice)
library(stringr)
library(ggthemes)
library(RCurl)
library(rstan)
library(lme4)
library(printr)
library(hexbin)
library(ggbeeswarm)
library(viridis)
library(gridExtra)
library(cetcolor)
library(ggjoy)
library(ggpmisc)
library(readxl)
library(sp)
library(maps)
library(maptools)
library(rgdal)
library(soilDB)
library(GGally)

# when ggjoy is decomisioned replace with  "ggridge", 

```



###Bring NWCA and RaCA datasets with SOC and bulk density from publicly availalbe data.  Add location information which is sensitve and only shared with permission.

**RaCA** - Rapid Carbon Assessment Project.  Information and data available at https://www.nrcs.usda.gov/wps/portal/nrcs/detail/soils/survey/?cid=nrcs142p2_054164

**NWCA** -  National Wetland Condition Assessment. Information and data available at: https://www.nrcs.usda.gov/wps/portal/nrcs/detail/soils/survey/?cid=nrcs142p2_054164
Data for this project was made available as part of the soil property cooperation with Kellogg Soil Survey Laboratory.

**this code chunk downloads data into the folder with this project - uncomment to run**

```{r dataDownload}

raca.url <- 'https://nrcs.box.com/shared/static/nivz52qvsgyalx5zir8sgcu7lpp048pl.csv'
ifelse(!file.exists('RaCA_samples.csv'), download.file(raca.url, destfile = paste0('RaCA_samples.csv') )
       , "File already downloaded")

nwca.url <- 'https://nrcs.box.com/shared/static/u3qahrgycjzenwxykiabh93cnmk4r1e6.csv'
ifelse(!file.exists('nwca.SOCsamples_5-10.csv'), download.file(nwca.url, destfile = paste0('nwca.SOCsamples_5-10.csv')), "File already downloaded")


```


##Read Data into R and Prep
#### Combine dataset into one

* Add location data
* Check field names
* Select relevant fields
* Harmonize datasets
  + Rename to same field names
  + Add SET to denote dataset
  + Add any missing fields (assign values or unknown)
      + LU - to match RaCA W- wetland, C- cropland, P- pastureland, F - Forestland, X- CRP, U added for unknown
  
_Master Horizons (M) set for each dataset in previous data management_
_Texture labels need to be assessed in ensure the same abbreviations are being used_


```{r dataPrep}

raca <- read.csv(paste0('RaCA_samples.csv'))

raca.loc <- read.csv('RaCA_xy.csv')

raca <- left_join(raca, raca.loc, by =c("rcasiteid" = "RaCA_site"))

raca$CALC_SOC <- ifelse(!is.na(raca$caco3),                      ifelse(raca$caco3>0,raca$c_tot_ncs-(raca$caco3*0.12),raca$c_tot_ncs), raca$c_tot_ncs)
raca$SOC <- ifelse(raca$CALC_SOC<0, 0, raca$CALC_SOC)
r <- raca[!is.na(raca$Measure_BD), c("samp", "upedon", "TOP", "BOT", "hzn_desgn", "Model_desg", "M", "texture", "fragvolc", "SOC", "Measure_BD", "Model_BD", "LU", "Lat", "Lon", "rcasiteid")]
names(r) <- c("samp_id", "Pedon_ID", "Top", "Bottom", "Hzn_name","Model_desg", "M", "Texture",  "CoarseFrag", "SOC", "BD", "RF.BD","LU","Lat", "Lon", "Alt_ID" )
r$SET <- "RaCA"
r$Clay <- NA
r$Alt_ID <- as.factor(r$Alt_ID)


nwca <- read.csv('nwca.SOCsamples_5-10.csv')
nwca.loc <- read.csv('NWCA2011_SITEINFO_081315.csv')

nwca <- left_join(nwca, nwca.loc, by = "UID")

w <- nwca[!is.na(nwca$BD), c( "samp", "Pedon", "top", "bottom","HORIZON", "Model_desg", "M", "TEXTURE_CLASS", "CLAY", "ROCK_FRAGMENTS", "SOC", "BD", "Model", "AA_CENTER_LAT", "AA_CENTER_LON", "UID")]
          

names(w) <- c("samp_id", "Pedon_ID" ,"Top", "Bottom", "Hzn_name","Model_desg", "M", "Texture", "Clay", "CoarseFrag", "SOC", "BD", "RF.BD", "Lat", "Lon", "Alt_ID")
w$LU <- "W"
w$SET <- "NWCA"
w$Pedon_ID <- as.factor(w$Pedon_ID)
w$Alt_ID <- as.factor(w$Alt_ID)

#combine dataset into one - keep one record per duplicates, missing values are filled with NA
combo <- distinct(rbind(r,w))



#there are a number of really high bulk density numbers - primarily in the ISCN set - need to investigate further
combo <- combo %>% filter(BD<2) 


#secondary dataset with All values


#knitr::kable(n_M),digits = 1, col.names =names(n_S), caption = "Number of Samples in each Dataset", row.names =F, padding= 2)

```

```{r pedSOC}
#limit calculations to central pedons that have laboratory data
COMBO<- distinct(rbind(r,w))

#count sites by SET and land use 
#MO is an abbreviation for RaCA Region and LU is the abbreviation for Land Use/Land Cover class

COMBO %>% group_by(SET, LU) %>% summarise(Pedons = n_distinct(Pedon_ID), Samples = n_distinct(samp_id))


#simplify variables and calculate SOC density for each sample

COMBO <- COMBO %>%
  #use modeled value if there is no measured BD
#use modeled value for impossibly high BD in organic horizons
      mutate(BD = ifelse(is.na(BD), RF.BD,
                                          ifelse(M == "O"|M == "U",
                                                     ifelse(BD>1, RF.BD,
                                                               ifelse(BD>2, RF.BD, BD)), BD)
                         ),
             SOCd = SOC*BD,
             SOCden = SOC*BD*(1 - ifelse(CoarseFrag == 0, 0, CoarseFrag/100)),
             Thick = Bottom - Top
             )

COMBO <- distinct(COMBO)
3

# #was trying to write this as a function - problems with dplyr and 'tidyeval'
# #https://www.youtube.com/watch?utm_campaign=buffer&feature=youtu.be&utm_source=twitter.com&utm_content=bufferba2dd&utm_medium=social&v=nERXS3ssntw&app=desktop
# #https://adv-r.hadley.nz/expressions.html
# #     
# fixed <- function(dataset, Depth, PedID_colname = Pedon_ID, SOC_colname = SOC, BD_colname= BD, Bottom_colname = Bottom, Top_colname = Top, FragVol_colname = CourseFrag){
#   require("dplyr")
#        quo_Depth = quo(Depth) 
#        quo_PedID_colname = quo(PedID_colname)
#        quo_SOC_colname = quo(SOC_colname) 
#        quo_BD_colname = quo(BD_colname)
#        quo_Bottom_colname = quo(Bottom_colname)
#        quo_Top_colname = quo(Top_colname)
#        quo_FragVol_colname = quo(CourseFrag_colname)  
#         dataset %>%
#       filter_(quo_Bottom_colname <= quo_Depth) %>%
#         mutate_(soc.depth = quo_Bottom_colname - quo_Top_colname,
#                 SOCs = soc.depth * SOCden) %>%
#         group_by_(PedonID_colname) %>%
#         summarise_( SOCstock = sum(SOCs))
#   return(dataset)
# }
# 
# 
# CM <- COMBO[,1:20]
#  
# fixed(CM, 5)
# 
# fixed(CM, 5, PedID_colname = Pedon_ID, SOC_colname = SOC, BD_colname= BD, Bottom_colname = Bottom, Top_colname = Top, FragVol_colname = CourseFrag)

# 
# COMBO$SOC_5 <- ifelse(COMBO$Bottom<=5, COMBO$Thick,ifelse(COMBO$Top<5, 5-COMBO$Top,0))
# 
# COMBO$SOC_30 <- ifelse(COMBO$Bottom<=30, COMBO$Thick,
#                     ifelse(COMBO$Top<30, 30-COMBO$Top,0))
# 
# COMBO$SOC_100 <- ifelse(COMBO$Bottom<=100, COMBO$Thick,
#                     ifelse(COMBO$Top<100, 100-COMBO$Top,0))

# #calculate layer stocks - assigned depth * SOCden 
# #native units are Mg/ha
# COMBO$SOCstock5 <- with(COMBO, SOCden*SOC_5)
# COMBO$SOCstock30 <- with(COMBO, SOCden*SOC_30)
# COMBO$SOCstock100 <- with(COMBO, SOCden*SOC_100)
# 
# #sum SOC by pedon
# SOC_5 <- aggregate(SOCstock5~SET + LU + Pedon_ID, data=COMBO, FUN=sum)
# SOC_30 <- aggregate(SOCstock30~Pedon_ID, data=COMBO, FUN=sum)
# SOC_100 <-aggregate(SOCstock100~Pedon_ID, data=COMBO, FUN=sum) 


#additional information about pedons used to screen for pedons that do not meet depth requirements
#pedon id info

hard <- c("Bkm", "Bkmm", "Bqm", "R", "Cr", "m")#R or other restrictive layer (assumed to have negligble SOC at this depth and below)


ped<- COMBO %>%
  mutate(SOC_5 = ifelse(Bottom<=5, Thick,ifelse(Top<5, 5-Top,0)),
         SOC_30 = ifelse(Bottom<=30, Thick,ifelse(Top<30, 30-Top,0)),
         SOC_100 = ifelse(Bottom<=100, Thick,ifelse(Top<100, 100-Top,0))) %>%
  mutate (SOCstock_in_5 = SOCden*SOC_5,
          SOCstock_in_30 = SOCden*SOC_30,
          SOCstock_in_100 = SOCden*SOC_100)%>%
  group_by(SET, LU, Pedon_ID) %>%
  summarise(SOCstock5 = sum(SOCstock_in_5, na.rm=T),
            SOCstock30 = sum(SOCstock_in_30, na.rm=T),
            SOCstock100 = sum(SOCstock_in_100, na.rm=T),
            Sample_count = n_distinct(samp_id),
            total_thickness = sum(Thick, na.rm=T),
            ped_bott = max(Bottom),
            Lab_count = n_distinct(samp_id[!is.na(SOC)]),
            Lab_thick = sum(Thick[!is.na(SOC)]),
            NonR_SampleCount = n_distinct(samp_id[grep("R", Model_desg, invert=T, ignore.case=T)]),
            Pedon_top = min(Top),
            Depth_to_R = min(Top[grep(paste(hard, collapse='|'), Model_desg, ignore.case=T)]),
            Depth_of_O = sum(Thick[M=='O'])
           )  %>%
  ungroup()%>%
  mutate(Depth_to_R = ifelse(!is.infinite(Depth_to_R), Depth_to_R, NA),
          Use = ifelse(SOCstock5 == 0, 'Top_anal_missing',
                                              ifelse(Lab_count < Sample_count,
                                                                                ifelse(Lab_thick < total_thickness, 
                                                                                                  ifelse(!is.na(Depth_to_R),  
                                                                                                         ifelse(Depth_to_R >= Lab_thick , "MISS_anal",
                                                                                                                                   ifelse(Lab_thick >= 100, '100',
                                                                                                                                   ifelse(Lab_thick >= 30, '30',
                                                                                                                                  ifelse(Lab_thick >= 5, '5', 'NA')))
                                                                                                                ),
                                                                                                                  ifelse(Lab_thick >= 100, '100',
                                                                                                                  ifelse(Lab_thick >= 30, '30',
                                                                                                                  ifelse(Lab_thick >= 5, '5', 'NA')))
                                                                                                                                                    )                        
                                                                                                                    ,
                                                                                     ifelse(Lab_thick >= 100, '100',
                                                                                      ifelse(Lab_thick >= 30, '30',
                                                                                      ifelse(Lab_thick >= 5, '5', 'NA')))
                                                                                                                          )
                                                                                ,                   
                                                                                ifelse(Lab_thick >= 100, '100',
                                                                                ifelse(Lab_thick >= 30, '30',
                                                                                ifelse(Lab_thick >= 5, '5', 'NA')))
                                                                                                                    )
                      )
          )


#use the 'USE' field to delete stock calculations that might be erroneous (this i(s conservative, may be elimanating useful data)

SOC_ped <- ped %>%
  mutate(SOCstock5 = ifelse(Use %in% c(5,30, 100), SOCstock5, NA),
         SOCstock30 = ifelse(Use %in% c(30,100), SOCstock30, NA),
         SOCstock100 = ifelse(Use %in% c(100), SOCstock100, NA)
      )

```

##Compare Datasets
Use dplyr (with piping) to format and ggplot to create graphs

```{r graphs}
d <- combo %>%
  ggplot(aes(BD)) + geom_density(aes(fill = SET), alpha=.5) + scale_x_continuous(limits = c(0,3))+
  facet_wrap(~M) + ggtitle('Bulk density by Master Horizon')


b <- combo %>%
  #filter(!is.na(BD)) %>%
  ggplot(aes(y = BD, x=SET)) + geom_boxplot(aes(fill=LU)) +
  facet_wrap(~M) + ggtitle('Bulk density by Dataset and Land Use/Cover Class')


grid.arrange(d,b, ncol=2)

o <- combo %>%
  filter(!is.na(BD) & M == "O") %>%
  ggplot(aes(y = BD, x=SET)) + geom_boxplot(aes(fill=LU)) +
  ggtitle('For O (organic) horizons only \n Bulk density by Master Horizon and Land Use/Cover Class')


s <- combo %>%
  filter(!is.na(BD) & M == "O") %>%
  ggplot(aes(y = BD, x=SOC)) + geom_point(aes(color=LU, shape = SET)) +
  ggtitle('For O (organic) horizons only \n Bulk density and SOC')


S <- combo %>%
  filter(!is.na(BD) & M == "O") %>%
  ggplot(aes(y = 1/BD, x=SOC)) + geom_point(aes(color=LU, shape = SET)) +
  ggtitle('For O (organic) horizons only \n Bulk density and SOC')

Sw <- combo %>%
  filter(!is.na(BD) & M == "O" & LU == "W") %>%
  ggplot(aes(y = 1/BD, x=SOC)) + geom_point(aes(color=SET, shape = SET)) +
  ggtitle('For O (organic) horizons in Wetlands only \n Bulk density and SOC')

grid.arrange(o, s, S,Sw, ncol=2)

```


```{r r-plots}

#joy plot with continuous fill
R <- combo %>%
      filter(!is.na(BD)) %>%
      ggplot(aes(x=BD, y = SET, fill = ..x..)) +  
    geom_joy_gradient()  + 
    scale_fill_gradientn(colours = cet_pal(5, name = "fire"), name = "BD")+
    theme_joy() +
    theme(plot.caption=element_text(hjust=0,size=9),
        axis.title=element_text(size=12),
        plot.title=element_text(size=24))+
    labs(x="Bulk Density",y="Dataset",caption="@wills_skye", title="Ridgeplot of BD by Dataset")




#bee swarm
B <- combo %>%
      filter(!is.na(BD)) %>%
  ggplot(aes(x=BD, y = SET, color = BD)) +  
  geom_quasirandom(alpha=0.82, groupOnX=FALSE) + 
  scale_color_gradientn(colours = cet_pal(10, name = "cyclic_mrybm_35-75_c68_n256"), name = "BD")+
  theme_joy() +
  theme(plot.caption=element_text(hjust=0,size=9),
        axis.title=element_text(size=12),
        plot.title=element_text(size=24))+
  labs(x="Bulk Density",y="Dataset",caption="@wills_skye", title="Beeswarm Plot of BD by Dataset")



#add SOC measurement for visulaization
B_C <- combo %>%
      filter(!is.na(BD)&!is.na(SOC) ) %>%
  ggplot(aes(x=BD, y = SET, color = SOC)) +  
  geom_quasirandom(alpha=0.82, groupOnX=FALSE) + 
  scale_color_viridis()+
  theme_joy() +
  theme(plot.caption=element_text(hjust=0,size=9),
        axis.title=element_text(size=12),
        plot.title=element_text(size=24))+
  labs(x="Bulk Density",y="Dataset",caption="@wills_skye", title="Beeswarm Plot of BD by Dataset")



#limit to organic horizons
#bee swarm
Bo <- combo %>%
      filter(!is.na(BD) & M =='O') %>%
  ggplot(aes(x=BD, y = SET, color = BD)) +  
  geom_quasirandom(alpha=0.82, groupOnX=FALSE) + 
  scale_color_gradientn(colours = cet_pal(10, name = "cyclic_mrybm_35-75_c68_n256"), name = "BD")+
  theme_joy() +
  theme(plot.caption=element_text(hjust=0,size=9),
        axis.title=element_text(size=12),
        plot.title=element_text(size=24))+
  labs(x="Bulk Density",y="Dataset",caption="@wills_skye", title="Bulk Density of Organic Horizons \n by Dataset")



Bow <- combo %>%
      filter(!is.na(BD) & M =='O' & LU =='W') %>%
  ggplot(aes(x=BD, y = SET, color = BD)) +  
  geom_quasirandom(alpha=0.82, groupOnX=FALSE) + 
  scale_color_gradientn(colours = cet_pal(10, name = "cyclic_mrybm_35-75_c68_n256"), name = "BD")+
  theme_joy() +
  theme(plot.caption=element_text(hjust=0,size=9),
        axis.title=element_text(size=12),
        plot.title=element_text(size=24))+
  labs(x="Bulk Density",y="Dataset",caption="@wills_skye", title="Bulk Density of O Horizons \n in Wetlands by Dataset")



#with SOC measurement
BoC <- combo %>%
      filter(!is.na(BD) &!is.na(SOC) & M =='O') %>%
  ggplot(aes(x=BD, y = SET, color = SOC)) +  
  geom_quasirandom(alpha=0.82, groupOnX=FALSE) + 
  scale_color_viridis(option = "viridis")+
  theme_joy() +
  theme(plot.caption=element_text(hjust=0,size=9),
        axis.title=element_text(size=12),
        plot.title=element_text(size=24))+
  labs(x="Bulk Density",y="Dataset",caption="@wills_skye", title="Bulk Density of O Horizons \n by Dataset")



BowC <- combo %>%
      filter(!is.na(BD) &!is.na(SOC) & M =='O' & LU =='W') %>%
  ggplot(aes(x=BD, y = SET, color = SOC)) +  
  geom_quasirandom(alpha=0.82, groupOnX=FALSE) + 
  scale_color_viridis(option = "viridis")+
  theme_joy() +
  theme(plot.caption=element_text(hjust=0,size=9),
        axis.title=element_text(size=12),
        plot.title=element_text(size=24))+
  labs(x="Bulk Density",y="Dataset",caption="@wills_skye", title="Bulk Density of O Horizons \n in Wetlands by Dataset")



BowCc <- combo %>%
      filter(!is.na(BD) &!is.na(SOC) & M =='O' & LU =='W' & SOC>20) %>%
  ggplot(aes(x=BD, y = SET, color = SOC)) +  
  geom_quasirandom(alpha=0.82, groupOnX=FALSE) + 
  scale_color_viridis(option = "viridis")+
  theme_joy() +
  theme(plot.caption=element_text(hjust=0,size=9),
        axis.title=element_text(size=12),
        plot.title=element_text(size=14))+
  labs(x="Bulk Density",y="Dataset",caption="@wills_skye", title="Bulk Density of O Horizons with SOC > 20% \n in Wetlands by Dataset")



BowT <- combo %>%
      filter(!is.na(BD) &!is.na(SOC) & M =='O' & LU =='W') %>%
  ggplot(aes(x=BD, y = SET, color = Top)) +  
  geom_quasirandom(alpha=0.5, groupOnX=FALSE) + 
  scale_color_viridis(option = "magma")+
  theme_joy() +
  theme(plot.caption=element_text(hjust=0,size=9),
        axis.title=element_text(size=12),
        plot.title=element_text(size=24))+
  labs(x="Bulk Density",y="Dataset",caption="@wills_skye", title="Bulk Density of O Horizons \n in Wetlands by Dataset")



BowTc <- combo %>%
      filter(!is.na(BD) &!is.na(SOC) & M =='O' & LU =='W' & SOC > 20) %>%
  ggplot(aes(x=BD, y = SET, color = Top)) +  
  geom_quasirandom(alpha=0.5, groupOnX=FALSE) + 
  scale_color_viridis(option = "magma")+
  theme_joy() +
  theme(plot.caption=element_text(hjust=0,size=9),
        axis.title=element_text(size=12),
        plot.title=element_text(size=24))+
  labs(x="Bulk Density",y="Dataset",caption="@wills_skye", title="Bulk Density of O Horizons \n in Wetlands by Dataset")



#prep select graphs for export
B <- combo %>%
      filter(!is.na(BD)) %>%
  ggplot(aes(x=BD, y = SET, color = BD)) +  
  geom_quasirandom(alpha=0.82, groupOnX=FALSE) + 
  scale_color_gradientn(colours = cet_pal(10, name = "cyclic_mrybm_35-75_c68_n256"), guide = FALSE)+
  theme_joy() +
  theme(plot.caption=element_text(hjust=0,size=9),
        axis.title=element_text(size=12),
        plot.title=element_text(size=24))+
  #labs(x="Bulk Density",y="Dataset",caption="@wills_skye", title="Beeswarm Plot of BD by Dataset")
 labs(x =expression(paste('Bulk Density (g cm'^-3,')')), y='Dataset')



# ggsave('BDswarm_all.png', plot = B, device = "png", path = 'C:/Users/skye.wills/ownCloud/AGU_BD-OMgraphs/poster', scale = 1, width = 6, height = 3, units = "in", dpi = 600, limitsize = TRUE)


BowC <- combo %>%
      filter(!is.na(BD) &!is.na(SOC) & M =='O' & LU =='W') %>%
  ggplot(aes(x=BD, y = SET, color = SOC)) +  
  geom_quasirandom(alpha=0.82, groupOnX=FALSE) + 
  scale_color_viridis(option = "viridis")+
  theme_joy() +
  theme(plot.caption=element_text(hjust=0,size=9),
        axis.title=element_text(size=12),
        plot.title=element_text(size=24))+
#labs(x="Bulk Density",y="Dataset",caption="@wills_skye", title="Bulk Density of O Horizons \n in Wetlands by Dataset")
 labs(x =expression(paste('Bulk Density (g cm'^-3,')')), y='Dataset', color = 'SOC (%)')



grid.arrange(R, B, B_C,Sw, ncol=2)
grid.arrange(Bo,Bow, BowC, BowCc, ncol=2)
grid.arrange(BowT, BowTc, ncol=2)
```


```{r SOCden}

Den1 <- combo %>%
  mutate(SOCden = BD*SOC/100) %>%    
  filter(!is.na(BD) &!is.na(SOC)) %>%
      
  ggplot(aes(x=SOCden, y = Top, color = SET)) +  geom_point(size =6, alpha = 0.5) +
theme_joy() + scale_y_reverse() +
  theme(plot.caption=element_text(hjust=0,size=9),
        axis.title=element_text(size=12),
        plot.title=element_text(size=24))+
#labs(x="Bulk Density",y="Dataset",caption="@wills_skye", title="Bulk Density of O Horizons \n in Wetlands by Dataset")
 labs(x =expression(paste('SOC Density (g cm'^-3,')')), y='Top Depth (cm)', color = 'Dataset', title = 'All horizons')


Den <- combo %>%
  mutate(SOCden = BD*SOC/100) %>%    
  filter(!is.na(BD) &!is.na(SOC) & M =='O' & LU =='W') %>%
      
  ggplot(aes(x=SOCden, y = Top, color = SET)) +  geom_point(size =6, alpha = 0.5) +
theme_joy() + scale_y_reverse() +
  theme(plot.caption=element_text(hjust=0,size=9),
        axis.title=element_text(size=12),
        plot.title=element_text(size=24))+
#labs(x="Bulk Density",y="Dataset",caption="@wills_skye", title="Bulk Density of O Horizons \n in Wetlands by Dataset")
 labs(x =expression(paste('SOC Density (g cm'^-3,')')), y='Top Depth (cm)', color = 'Dataset', title = 'Wetland field described O horizons')




#

Den2 <- combo %>%
   filter(!is.na(BD) &!is.na(SOC)) %>%
  mutate(SOCden = BD*SOC/100) %>% 
   mutate(D = cut(Top, breaks = c(0,10,25,50,100), labels = c('0 - 10cm', '10 - 25cm','25 - 50cm', '50 - 100cm'))) %>%
  mutate(D = factor(D, levels = rev(levels(D))))%>%
    filter(!is.na(D)) %>% 
  group_by(samp_id, M, LU,SET,D )  %>%
  summarize(SD = mean(SOCden, na.rm=T)) %>%
 ggplot(sata= DD2, aes(y=SD, x =D)) +     geom_jitter(aes(color = M), size =4, alpha = 0.5) + 
  geom_boxplot(color = "grey", alpha = 0.5)  +  
  theme_joy() +  scale_y_continuous(limits = c(0,0.5) ) +coord_flip()  +
  theme(plot.caption=element_text(hjust=0,size=9),
        axis.title=element_text(size=12),
        plot.title=element_text(size=24))+
#labs(x="Bulk Density",y="Dataset",caption="@wills_skye", title = ' Carbon Density of all horizons)
 labs(x =expression(paste('SOC Density (g cm'^-3,')')), y='Depth Class (cm)', color = 'Master Horizon', title = 'All horizons') +
  facet_wrap(~SET)



Den2O <- combo %>%
   filter(!is.na(BD) &!is.na(SOC) & M == "O") %>%
  mutate(SOCden = BD*SOC/100) %>% 
   mutate(D = cut(Top, breaks = c(0,10,25,50,100), labels = c('0 - 10cm', '10 - 25cm','25 - 50cm', '50 - 100cm'))) %>%
  mutate(D = factor(D, levels = rev(levels(D))))%>%
    filter(!is.na(D)) %>% 
  group_by(samp_id, M, LU,SET,D )  %>%
  summarize(SD = mean(SOCden, na.rm=T)) %>%
 ggplot(sata= DD2, aes(y=SD, x =D)) +     geom_jitter(color = "lightblue", size =4, alpha = 0.75) + 
  geom_boxplot(color = "grey", alpha = 0.75)  +  
  theme_joy() +  scale_y_continuous(limits = c(0,0.5) ) +coord_flip()  +
  theme(plot.caption=element_text(hjust=0,size=9),
        axis.title=element_text(size=12),
        plot.title=element_text(size=24))+
#labs(x="Bulk Density",y="Dataset",caption="@wills_skye", title = ' Carbon Density of all horizons)
 labs(y =expression(paste('SOC Density (g cm'^-3,')')), x='Depth Class (cm)', color = 'Master Horizon', title = 'Organic horizons (field Described)') +
  facet_wrap(~SET)

#check O horizons
combo %>% filter(grepl("O", Model_desg, ignore.case= FALSE)) %>%group_by(SET,Model_desg) %>% summarize( n = n_distinct(samp_id)) %>% spread(SET,Model_desg)



Den2Oc <- combo %>%
   filter(!is.na(BD) &!is.na(SOC) & M == "O") %>%
  mutate(SOCden = BD*SOC/100) %>% 
   mutate(D = cut(Top, breaks = c(0,10,25,50,100), labels = c('0 - 10cm', '10 - 25cm','25 - 50cm', '50 - 100cm'))) %>%
  mutate(D = factor(D, levels = rev(levels(D))))%>%
    filter(!is.na(D)) %>% 
  group_by(samp_id, M, LU,SET,D )  %>%
  summarize(SD = mean(SOCden, na.rm=T), SOCm  = mean(SOC)) %>%
 ggplot(sata= DD2, aes(y=SD, x =D)) +     geom_jitter(aes(color = SOCm), size =4, alpha = 0.95) + 
  geom_boxplot(color = "grey", alpha = 0.75)  +  
  theme_joy() +  scale_color_gradient2(low = "dark blue", mid = "white", high = "green", midpoint = 20) +    scale_y_continuous(limits = c(0,0.5) ) +coord_flip()  +
  theme(plot.caption=element_text(hjust=0,size=9),
        axis.title=element_text(size=12),
        plot.title=element_text(size=24))+
#labs(x="Bulk Density",y="Dataset",caption="@wills_skye", title = ' Carbon Density of all horizons)
 labs(y =expression(paste('SOC Density (g cm'^-3,')')), x='Depth Class (cm)', color = '% SOC', title = 'SOCden with SOC \n Organic horizons, field described') +
  facet_wrap(~SET)



Den2Od <- combo %>%
   filter(!is.na(BD) &!is.na(SOC) & M == "O") %>%
  mutate(SOCden = BD*SOC/100) %>% 
   mutate(D = cut(Top, breaks = c(0,10,25,50,100), labels = c('0 - 10cm', '10 - 25cm','25 - 50cm', '50 - 100cm'))) %>%
  mutate(D = factor(D, levels = rev(levels(D))))%>%
    filter(!is.na(D)) %>% 
  group_by(samp_id, M, LU,SET,D )  %>%
  summarize(SD = mean(SOCden, na.rm=T), SOCm  = mean(SOC), BDm = mean(BD)) %>%
 ggplot(sata= DD2, aes(y=SD, x =D)) +     geom_jitter(aes(color = BDm), size =4, alpha = 0.95) + 
  geom_boxplot(color = "grey", alpha = 0.75)  +  
  theme_joy() +  scale_color_gradient2(low = "black", mid = "white", high = "red", midpoint = 0.5) +    scale_y_continuous(limits = c(0,0.5) ) +coord_flip()  +
  theme(plot.caption=element_text(hjust=0,size=9),
        axis.title=element_text(size=12),
        plot.title=element_text(size=24))+
#labs(x="Bulk Density",y="Dataset",caption="@wills_skye", title = ' Carbon Density of all horizons)
 labs(y =expression(paste('SOC Density (g cm'^-3,')')), x='Depth Class (cm)', color = 'Bulk Density \n g/cm3', title = 'SOCden with BD \n Organic horizons, field described') +
  facet_wrap(~SET)


 CO <- combo %>%
   filter(!is.na(BD) &!is.na(SOC) & M == "O"& LU =="W") %>%
  mutate(SOCden = BD*SOC/100) %>% 
   mutate(D = cut(Top, breaks = c(0,10,25,50,100), labels = c('0 - 10cm', '10 - 25cm','25 - 50cm', '50 - 100cm'))) %>%
  mutate(D = factor(D, levels = rev(levels(D))))
Den2OdW <-  CO %>%  filter(!is.na(D)) %>% 
  group_by(samp_id, M, LU,SET,D )  %>%
  summarize(SD = mean(SOCden, na.rm=T), SOCm  = mean(SOC), BDm = mean(BD)) %>%
 ggplot(sata= DD2, aes(y=SD, x =D)) +     geom_jitter(aes(color = BDm), size =4, alpha = 0.95) + 
  geom_boxplot(color = "grey", alpha = 0.75)  +  
  theme_joy() +  scale_color_gradient2(low = "black", mid = "white", high = "red", midpoint = 0.5) +    scale_y_continuous(limits = c(0,0.5) ) +coord_flip()  +
  theme(plot.caption=element_text(hjust=0,size=9),
        axis.title=element_text(size=12),
        plot.title=element_text(size=24))+
#labs(x="Bulk Density",y="Dataset",caption="@wills_skye", title = ' Carbon Density of all horizons)
 labs(y =expression(paste('SOC Density (g cm'^-3,')')), x='Depth Class (cm)', color = 'Bulk Density \n g/cm3', title = 'Organic horizons, field described, \n in Wetlands') +
  facet_wrap(~SET)

CO <-combo %>%
   filter(!is.na(BD) &!is.na(SOC) & M == "O"& LU =="W") %>%
  mutate(hz_O <- as.factor(as.character(Model_desg))%>%
  mutate(SOCden = BD*SOC/100) %>% 
   mutate(D = cut(Top, breaks = c(0,10,25,50,100), labels = c('0 - 10cm', '10 - 25cm','25 - 50cm', '50 - 100cm'))) %>%
    mutate(Model_desg = droplevels(Model_desg)) %>%
  mutate(D = factor(D, levels = rev(levels(D))))%>%
    filter(!is.na(D)) %>% 
  group_by(samp_id, M, LU,SET,D,Model_desg  ) %>%
  summarize(SD = mean(SOCden, na.rm=T), SOCm  = mean(SOC), BDm = mean(BD), CF = mean(CoarseFrag)) 

DenOTYPE <- CO %>% ggplot(sata= DD2, aes(y=SD, x =D)) +  geom_jitter(aes(color = CF), size =4, alpha = 0.75)+ 
  geom_boxplot(aes(fill = Model_desg), alpha = 0.75)  +  
  scale_fill_brewer(palette = "Set1") + 
  theme_joy() +  scale_color_gradient2(low = "white", mid = "black", high = "green", midpoint = 10) +    scale_y_continuous(limits = c(0,0.5) ) +coord_flip()  +
  theme(plot.caption=element_text(hjust=0,size=9),
        axis.title=element_text(size=12),
        plot.title=element_text(size=24))+
#labs(x="Bulk Density",y="Dataset",caption="@wills_skye", title = ' Carbon Density of all horizons)
 labs(y =expression(paste('SOC Density (g cm'^-3,')')), x='Depth Class (cm)', color = 'Coarse Fragments, %', title = 'Organic horizons, field described, \n in Wetlands') 
  
DenOTYPE +  facet_grid( Model_desg ~ SET)
DenOTYPE +  facet_grid( ~ SET)



# #find samples that are high in OM, but also have high bulk density
# sample_flag <- combo %>%
#    filter(!is.na(BD) &!is.na(SOC) & M == "O"& LU =="W") %>%
#   mutate(SOCden = BD*SOC/100) %>% 
#   filter(SOC > 10, BD > 0.5) 


# #find unique pedon id
# Ped_flag <-  sample_flag %>%
#   group_by(Pedon_ID) %>%
#   summarize(SOCdenM = mean(SOCden, na.rm=T), SOCm  = mean(SOC), BDm = mean(BD),
#             SDmax = max(SOCden), SOCmax =max(SOC), BDmax = max(BD))
# 
# raca_flag <- Ped_flag %>%
#  right_join(raca %>% filter(!is.na(SOC)) %>% mutate(Pedon_ID = upedonid)) %>%
#   filter(!is.na(SDmax))
# 
# raca_pedon_flag <- raca_flag %>%
#   select(rcasiteid) %>%
#   group_by(rcasiteid) %>%
#   summarise()


grid.arrange(Den1, Den, ncol = 2)
grid.arrange(Den2,Den2O, ncol =2)
grid.arrange(Den2Oc,Den2Od)
Den2OdW
DenOTYPE
```

use sf to create spatial stuff
``` {r spatial_sf}
library(sf)
# devtools::install_github("tidyverse/ggplot2")
# require(ggplot2)

PEDS <-distinct(SOC_ped %>% 
                  left_join(COMBO) %>% 
                  filter(!is.na(SOCstock5)))

peds <- distinct(PEDS %>% select(SET, LU, Pedon_ID, Lat, Lon, Alt_ID, SOCstock5, SOCstock30, SOCstock100,Depth_of_O, total_thickness)%>%
                            filter(Lat != 0, Lon != 0) %>%
                            filter(!is.na(Lat), !is.na(Lon))
                  )

ped_sf <- st_as_sf( peds, 
  coords = c("Lon", "Lat"),
    crs = "+proj=longlat +datum=WGS84")

plot(ped_sf)
plot(ped_sf["SET"])
plot(ped_sf[ped_sf$LU =="W","SET"], main = 'Wetland Sites')
plot(ped_sf["SOCstock100"], main = 'SOCstock 100cm')
plot(ped_sf["SOCstock30"])
plot(ped_sf["total_thickness"])

```


**NWCA wetland polygons

Find the centroid of each polygon

``` {r centroid}

#this failed but would theoretically add
#use geom_sf -- based on https://www.youtube.com/watch?v=B8tRjpcTCtQ
#need Rtools to run devtools
# devtools::install_github("tidyverse/ggplot2")
# library(ggplot2)
# ls("package:ggplot2")[120:130]

poly <- read_sf('NWCA2011_NWI_wet_poly.shp')

#ggplot(poly)+geom_sf()

plot(poly['WETLAND_TY'])

cent <- st_centroid(poly)

plot(cent['WETLAND_TY'], main = 'NWCA Wetland Type',key.pos = 1, axes = TRUE, key.size = lcm(2.5))


#nearest neighbor
#http://www.gis-blog.com/nearest-neighbour-search-for-spatial-points-in-r/



#geocomp https://geocompr.robinlovelace.net/spatial-data-operations.html
#4.2.6 Distance Relations

dist <- st_dsistance (ped_sf, cent) 



```


#pairs to look into
pair 1: uid - 4958 and RaCAsite C1606W04 __only 1 nwca sample with measurements__
pair2:  uid - 4366 and RaCAsite C1201C08 (RI island?) __these look like different soils__
pair3:   uid 4354 and 5211 and C1212W06 and C1206F04 __these are similar, but obviously not identical__
pari4: Pedon_ID %>% 4689, 4686, 4353, C1206W051, C1209W121


from Rob Tunstead - C1305W06 should be a good coastal tidal marsh from NJ
``` {r reps}

#recreate with fewer restrictions
#COMBO<- rbind(r,w)


pair1 <- COMBO %>% filter(Pedon_ID == 'C1606W041' | Pedon_ID == '4958' ) %>% mutate(SOCden = SOC*BD)
#only one NWCA sample
pair1 %>% ggplot(aes(SOCden, Top)) + geom_point(aes(color = SET))
pair1 %>% ggplot(aes(SOC, Top)) + geom_point() + scale_y_reverse()

pair2 <- COMBO %>% filter(Pedon_ID == 'C1201C081' | Pedon_ID == '4366' ) %>% mutate(SOCden = SOC*BD)
pair2 %>% ggplot(aes(SOC, Top)) + geom_point(aes(color = SET), size = 8) + scale_y_reverse()
pair2 %>% ggplot(aes(SOCden, Top)) + geom_point(aes(color = SET), size = 8) + scale_y_reverse()



pair3 <- COMBO %>% filter(Pedon_ID %in% c('4354', '5211', 'C1212W061', 'C1206F041')) %>% mutate(SOCden = SOC*BD)
p3a <- pair3 %>% ggplot(aes(SOC, Top)) + geom_point(aes(color = SET, shape = Pedon_ID), size = 8) + scale_y_reverse()
p3b <- pair3 %>% ggplot(aes(SOCden, Top)) + geom_point(aes(color = SET, shape = Pedon_ID), size = 8) + scale_y_reverse()
p3c <-pair3 %>% ggplot(aes(SOC, BD)) + geom_point(aes(color = SET, shape = Pedon_ID), size = 8) 

p3c
gp3 <- grid.arrange(p3a, p3b, ncol=2)
gp3
#write_csv(pair3, 'pair3.csv')


#pair 3 look similar but probobaly aren't the same soil

#pair4 - close, but all NWCA are much closer to the coast

#C1209W121 - no measured bd


pair4 <- COMBO %>% filter(Pedon_ID %in% c('4689', '4686', '4353', 'C1206W051', 'C1209W121')) %>% mutate(SOCden = SOC*BD)
p4a <- pair3 %>% ggplot(aes(SOC, Top)) + geom_point(aes(color = SET, shape = Pedon_ID), size = 8) + scale_y_reverse()
p4b <- pair4 %>% ggplot(aes(SOCden, Top)) + geom_point(aes(color = SET, shape = Pedon_ID), size = 8) + scale_y_reverse()
p4c <-pair4 %>% ggplot(aes(SOC, BD)) + geom_point(aes(color = SET, shape = Pedon_ID), size = 8) 

p4c
gp4 <- grid.arrange(p4a, p4b, ncol=2)
gp4
#write_csv(pair4, 'pair4.csv')

p4 <- raca %>% filter(rcasiteid == 'C1209W12') %>% mutate(SOCden = SOC*Measure_BD)


p1_r <- r %>% filter(rcasiteid == 'C1606W04') %>% mutate(SOCden = SOC*BD)


tidal_rep <- r %>% filter(rcasiteid == 'C1305W06') %>% mutate(SOCden = SOC*BD)


tidal_rep %>% ggplot(aes(SOC, TOP)) + geom_point() + scale_y_reverse()


#midwest examples

m1 <- COMBO %>% filter(Pedon_ID %in% c('C1007W101', '5888')) %>% mutate(SOCden = SOC*RF.BD)
                       
m1a <- m1 %>% ggplot(aes(SOC, Top)) + geom_point(aes(color = SET, shape = Pedon_ID), size = 8) + scale_y_reverse()
m1b <- m1 %>% ggplot(aes(SOCden, Top)) + geom_point(aes(color = SET, shape = Pedon_ID), size = 8) + scale_y_reverse()
m1c <-m1 %>% ggplot(aes(SOC, BD)) + geom_point(aes(color = SET, shape = Pedon_ID), size = 8) 

                       
                       
m2 <- COMBO %>% filter(Pedon_ID %in% c('C0703W081', '4846')) %>% mutate(SOCden = SOC*BD)
 m2a <- m2 %>% ggplot(aes(SOC, Top)) + geom_point(aes(color = SET, shape = Pedon_ID), size = 8) + scale_y_reverse()
m2b <- m2 %>% ggplot(aes(SOCden, Top)) + geom_point(aes(color = SET, shape = Pedon_ID), size = 8) + scale_y_reverse()
m2c <-m2 %>% ggplot(aes(SOC, BD)) + geom_point(aes(color = SET, shape = Pedon_ID), size = 8) 
                      

                       
m3  <- COMBO %>% filter(Pedon_ID %in% c('C0710R021', 'C0710R031','5194', '3456')) %>% mutate(SOCden = SOC*BD)    
      m3a <- m3 %>% ggplot(aes(SOC, Top)) + geom_point(aes(color = SET, shape = Pedon_ID), size = 8) + scale_y_reverse()
m3b <- m3 %>% ggplot(aes(SOCden, Top)) + geom_point(aes(color = SET, shape = Pedon_ID), size = 8) + scale_y_reverse()
m3c <-m3 %>% ggplot(aes(SOC, BD)) + geom_point(aes(color = SET, shape = Pedon_ID), size = 8) 
                  
                        

# tidal_rep %>% ggplot %>%
#    mutate(D = cut(TOP, breaks = c(0,10,25,50,100), labels = c('0 - 10cm', '10 - 25cm','25 - 50cm', '50 - 100cm'))) %>%
#   mutate(D = factor(D, levels = rev(levels(D))))%>%
#     filter(!is.na(D)) %>% 
#   group_by(samp, M, LU, D )  %>%
#   summarize(SD = mean(SOCden, na.rm=T), SOCm  = mean(SOC), BDm = mean(BD)) %>%
#  ggplot(aes(y=SD, x =D)) +     geom_jitter(aes(color = BDm), size =4, alpha = 0.95) + 
#   geom_boxplot(color = "grey", alpha = 0.75)  +  
#   theme_joy() +  scale_color_gradient2(low = "black", mid = "white", high = "red", midpoint = 0.5) +    scale_y_continuous(limits = c(0,0.5) ) +coord_flip()  +
#   theme(plot.caption=element_text(hjust=0,size=9),
#         axis.title=element_text(size=12),
#         plot.title=element_text(size=24))+
# #labs(x="Bulk Density",y="Dataset",caption="@wills_skye", title = ' Carbon Density of all horizons)
#  labs(y =expression(paste('SOC Density (g cm'^-3,')')), x='Depth Class (cm)', color = 'Bulk Density \n g/cm3', title = 'Representative Tidal March Site, NJ') 
#  


```
```{r depths}
#maybe use spline http://gsif.r-forge.r-project.org/mpspline.html (see below)
#or at least aqp to  slice/slab and then recombine depths
detach("package:tidyverse", unload=TRUE)
library(aqp)

x <- as.data.frame(distinct(PEDS))

#use aqp package to treat groups of samples as pedons with locations and depths
# promote to soil profile

depths(x) <- Pedon_ID  ~ Top + Bottom

# move some site-level data to site slot
site(x) <- ~ Pedon_ID + Alt_ID + SET + LU + Lat + Lon

a <- slab(x, Alt_ID ~ SOC + BD + SOCden)


## fit a spline:
SOCden.s <- mpspline(x, var.name="SOCden")
str(SOCden.s)

# 
# # 
# # coord_cartesian()
# # x <- join(data.frame(id, top, bottom, ORCDRC, munsell), 
# #          data.frame(id, lon, lat, FAO1988), type='inner')
# # depths(x) <- id ~ top + bottom
# # site(x) <- ~ lon + lat + FAO1988 
# # coordinates(x) <- ~ lon + lat
# # proj4string(x) <- CRS("+proj=longlat +datum=WGS84")
# # ## fit a spline:
# # ORCDRC.s <- mpspline(x, var.name="ORCDRC")
# # str(ORCDRC.s)
# 
# ## Example with multiple soil profiles
# ## Make some fake, but reasonable profiles:
# rand.prof <- ldply(1:20, random_profile, n=c(6, 7, 8), n_prop=1, method='LPP')
# ## promote to SPC and plot
# depths(rand.prof ) <- id ~ top + bottom
plot(rand.prof, color='p1')
## fit MP spline by profile
try( m <- mpspline(rand.prof, 'p1') )

# slice horizon samples into individual 1cm depth slices for calculation
# depth-wise quantiles, by LU
#because all pedons had a 0 -5cm sample collected and other depths were allowed to fluctuate, this creates some artifacts

a <- slab(x, LU ~ SOC + BD + SOCden)  
  
  
  #assign how layers are counted in stock calculations
#puts a number on the amount (cm) of each layer used in calculation

  #old SOC_5 - the cm within each depth 
combo_pedcalc <-  combo_pedcalc %>% mutate(samp_in_5 = ifelse(Bottom <=5, thick, ifelse(Top,5, 5 - Top ))
```
#pull in Rhode Island Data - From Jim Turenne

```{r uri_data}
URI <- read_csv("D:/Disk 2/NWCA/URI_tidal_marsh_data_MASTER.csv")



#generalize horizon name
n <- c('Oe','Oa', 'A', 'C')
#horizons names that will be matched
p <- c("Oe", "Oa", "A","Cg")

URI$genhz <- generalize.hz(URI$Horizon,n,p)

SOCBD <- URI  %>%
  ggplot(aes(x=SOC, y = BD)) +  geom_point(aes(color = genhz), alpha = 0.5) + facet_wrap(~marsh_setting)
SOCBD

SOMBD <- URI  %>%
  ggplot(aes(x=SOM, y = BD)) +  geom_point(aes(color = SOC)) + facet_wrap(~marsh_setting) +
  scale_color_gradient2(low = "dark green", mid = "light green", high = "blue", midpoint = 15)
SOMBD

SOCden <- URI  %>%
   mutate(SOCden = BD*SOC/100)%>%
  ggplot(aes(x=SOCden, y = upper)) +  geom_point(aes(color = Dist_ditch), alpha = 0.5)
SOCden


ggcorr(URI %>% select(Dist_ditch, upper, SOC, SOM, Fiber_Content, Rubbed_Fibers, BD, Initial_pH, Incubation_pH ) %>% mutate(Fiber_Content = as.numeric(Fiber_Content), Rubbed_Fibers = as.numeric(Rubbed_Fibers)), palette = "PuOr") 

ggpairs(URI %>% mutate(Fiber_Content = as.numeric(Fiber_Content), Rubbed_Fibers = as.numeric(Rubbed_Fibers)) %>% select(Dist_ditch, upper, SOC, SOM, Fiber_Content, Rubbed_Fibers, BD, Initial_pH, Incubation_pH))


URId <-URI %>%
   filter(!is.na(BD) &!is.na(SOC)) %>%
   mutate(SOCden = BD*SOC/100) %>% 
   mutate(D = cut(upper, breaks = c(0,10,25,50,100), labels = c('0 - 10cm', '10 - 25cm','25 - 50cm', '50 - 100cm'))) %>%
  mutate(D = factor(D, levels = rev(levels(D))))%>%
    filter(!is.na(D))


DenOTYPE <- URId %>% ggplot(aes(y=SOCden, x =D)) +  geom_jitter(color = "grey", size =4, alpha = 0.75)+ 
  geom_boxplot(aes(fill = genhz), alpha = 0.75)  +  
  scale_fill_brewer(palette = "Set1") + 
  theme_joy() +  scale_color_gradient2(low = "white", mid = "black", high = "green", midpoint = 10) +    scale_y_continuous(limits = c(0,0.5) ) +coord_flip()  +
  theme(plot.caption=element_text(hjust=0,size=9),
        axis.title=element_text(size=12),
        plot.title=element_text(size=24))+
#labs(x="Bulk Density",y="Dataset",caption="@wills_skye", title = ' Carbon Density of all horizons)
 labs(y =expression(paste('SOC Density (g cm'^-3,')')), x='Depth Class (cm)', fill = 'Generalized \n Horizon', title = 'SOC density and Horizon type') 

DenOTYPE
DenOTYPE + facet_wrap(~marsh_setting)


```

``` {r soilname}


```



##Locations
Summarize by pedons, select all wetlands and plot locations
How do we co-locate?


```{r loc}
library(png)
library(grid)

#one location per observation/pedon and clean lat/lon
C <- combo %>%
  filter(LU == "W" & Lat != 0) %>%
  select(SET, Pedon_ID, Lat, Lon, BD) %>%
  group_by(Pedon_ID) %>%
  mutate(Lat = ifelse(Lat == 0, NA, Lat), Lon = ifelse(Lon == 0, NA, Lon)) %>%
 summarize_all('min')
 
C_sp  <- C
  
#create spatial object 
names(C_sp) <- tolower(names(C_sp))
C_sp <- C_sp[complete.cases(C_sp),]

#xy cooridanates
coordinates(C_sp) <- ~ lon + lat
proj4string(C_sp) <- CRS("+proj=longlat +datum=WGS84")
C_sp <- spTransform(C_sp, CRS("+init=epsg:5070"))



us <- map("state", plot = FALSE)
us_sp <- {map2SpatialLines(us, proj4string = CRS("+init=epsg:4326")) ->.;
  spTransform(., CRS("+init=epsg:5070"))
}


#plot all
plot(C_sp, col = "lightgrey") # plot all points

#change color of NWCA points
setN <- C_sp$set =="NWCA"
plot(C_sp[setN, ], col = "turquoise") # add selected zones to map

#chang color of RACA points (wetlands)
plot(C_sp[C_sp$set =="RaCA", ], col = "grey")


plot(us_sp)

#=======
#spplot.points(C_sp)

####

cols <- brewer.pal(2, "RdYlBu")

C_sp$SET <- as.factor(C_sp$set)

plot(C_sp) 
plot(C_sp[C_sp$SET=='RaCA',])

par(mar=c(0,0,0,0))

map('state')
#points(C.sp, cex=0.5, pch=3, col='red'))


#mapview(C.sp)
 
```